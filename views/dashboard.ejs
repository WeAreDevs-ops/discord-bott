<%- include('layout', { title: 'Dashboard - Roblox Tools Bot', showSidebar: true, body: `
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-tachometer-alt me-2"></i>
                Dashboard
            </h2>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-server me-2"></i>
                                Your Servers
                            </h5>
                        </div>
                        <div class="card-body">
                            ${guilds.length > 0 ? `
                                <div class="row">
                                    ${guilds.map(guild => `
                                        <div class="col-md-6 col-lg-4 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center mb-3">
                                                        ${guild.icon ? `
                                                            <img src="https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png" 
                                                                 class="rounded me-3" width="48" height="48" alt="${guild.name}">
                                                        ` : `
                                                            <div class="bg-secondary rounded d-flex align-items-center justify-content-center me-3" 
                                                                 style="width: 48px; height: 48px;">
                                                                <i class="fas fa-server text-white"></i>
                                                            </div>
                                                        `}
                                                        <div>
                                                            <h6 class="card-title mb-1">${guild.name}</h6>
                                                            <small class="text-muted">
                                                                ${guild.owner ? '<i class="fas fa-crown text-warning me-1"></i>Owner' : 'Administrator'}
                                                            </small>
                                                        </div>
                                                    </div>
                                                    ${guild.botIsIn ? `
                                                        <a href="/guild/${guild.id}" class="btn btn-primary btn-sm">
                                                            <i class="fas fa-cog me-1"></i>
                                                            Configure
                                                        </a>
                                                        <div class="mt-2">
                                                            <small class="text-success">
                                                                <i class="fas fa-check-circle me-1"></i>
                                                                Bot is in server
                                                            </small>
                                                        </div>
                                                    ` : `
                                                        <a href="/auth/discord/bot-invite?guild_id=${guild.id}" class="btn btn-success btn-sm add-bot-btn" 
                                                           data-guild-id="${guild.id}" data-guild-name="${guild.name}">
                                                            <i class="fas fa-plus me-1"></i>
                                                            Add Bot
                                                        </a>
                                                        <div class="mt-2">
                                                            <small class="text-muted">
                                                                <i class="fas fa-info-circle me-1"></i>
                                                                Bot not in server
                                                            </small>
                                                        </div>
                                                    `}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-5">
                                    <i class="fas fa-server fa-3x text-muted mb-3"></i>
                                    <h5>No Servers Found</h5>
                                    <p class="text-muted">
                                        You don't have permission to manage any servers with this bot, or the bot hasn't been added to your servers yet.
                                    </p>
                                    <a href="https://discord.com/api/oauth2/authorize?client_id=${process.env.DISCORD_CLIENT_ID}&permissions=8&scope=bot%20applications.commands" 
                                       target="_blank" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>
                                        Add Bot to Server
                                    </a>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
` }) %>

<style>
      .server-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
      }

      .server-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-right: 16px;
        object-fit: cover;
      }

      .server-icon.default-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-right: 16px;
        background: #7289da;
        color: white;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .server-info h3 {
        margin: 0;
        font-size: 1.2em;
      }

      .server-info span {
        display: block;
        margin-top: 4px;
        font-size: 0.9em;
        color: #888;
      }

      .owner-badge {
        background: #f0ad4e;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
      }

      .configure-btn {
        background: #4CAF50;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        margin-left: auto;
        font-weight: 500;
        transition: background-color 0.2s;
      }

      .configure-btn:hover {
        background: #43A047;
      }

      .add-bot-btn {
        background: #5865f2;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        transition: background-color 0.2s;
      }

      .add-bot-btn:hover {
        background: #4752c4;
      }

      .bot-status {
        font-size: 0.85em;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
      }

      .bot-status.present {
        background: #57f287;
        color: #2b2d31;
      }

      .bot-status.absent {
        background: #ed4245;
        color: white;
      }
    </style>

    <script>
      function handleBotInvite(guildId) {
        // Open invite link in new window
        const inviteWindow = window.open(event.target.href, '_blank', 'width=500,height=700');

        // Check bot presence periodically after invitation
        let checkCount = 0;
        const maxChecks = 10;

        const checkBotPresence = setInterval(async () => {
          checkCount++;

          try {
            const response = await fetch(`/api/guild/${guildId}/bot-presence`);
            const data = await response.json();

            if (data.botPresent) {
              // Bot was added successfully
              clearInterval(checkBotPresence);
              updateServerCard(guildId, true);

              // Show success message
              showNotification('Bot added successfully! You can now configure it.', 'success');
            } else if (checkCount >= maxChecks) {
              // Stop checking after max attempts
              clearInterval(checkBotPresence);
            }
          } catch (error) {
            console.error('Error checking bot presence:', error);
            if (checkCount >= maxChecks) {
              clearInterval(checkBotPresence);
            }
          }
        }, 3000); // Check every 3 seconds

        // Prevent default link behavior since we opened it manually
        event.preventDefault();
        return false;
      }

      function updateServerCard(guildId, botPresent) {
        const serverCard = document.querySelector(`[data-guild-id="${guildId}"]`);
        if (!serverCard) return;

        const botStatus = serverCard.querySelector('.bot-status');
        const actionButton = serverCard.querySelector('.add-bot-btn, .configure-btn');

        if (botPresent) {
          // Update status
          botStatus.textContent = 'ðŸ¤– Bot Present';
          botStatus.className = 'bot-status present';

          // Update button
          actionButton.textContent = 'Configure';
          actionButton.className = 'configure-btn';
          actionButton.href = `/guild/${guildId}`;
          actionButton.onclick = null;
          actionButton.target = '_self';
        }
      }

      function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 6px;
          color: white;
          font-weight: 500;
          z-index: 1000;
          transition: opacity 0.3s;
          ${type === 'success' ? 'background: #57f287;' : 'background: #5865f2;'}
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Remove notification after 5 seconds
        setTimeout(() => {
          notification.style.opacity = '0';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 5000);
      }
    </script>
  </body>
</html>