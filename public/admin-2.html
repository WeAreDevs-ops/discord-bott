
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INC BOT - Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #2c2f33;
            min-height: 100vh;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #5865f2, #7289da);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .admin-card {
            background: #36393f;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid #42454a;
        }
        
        .admin-card h3 {
            color: #5865f2;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .server-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .server-item {
            background: #2c2f33;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .server-info {
            flex: 1;
        }
        
        .server-name {
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .server-details {
            color: #b9bbbe;
            font-size: 14px;
        }
        
        .server-stats {
            color: #5865f2;
            font-weight: 600;
        }
        
        .command-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .command-item {
            background: #2c2f33;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .command-name {
            color: #ffffff;
            font-family: 'Courier New', monospace;
        }
        
        .command-count {
            color: #5865f2;
            font-weight: 600;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #42454a;
        }
        
        .metric-label {
            color: #b9bbbe;
        }
        
        .metric-value {
            color: #ffffff;
            font-weight: 600;
        }
        
        .refresh-btn {
            background: #5865f2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #4752c4;
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            color: #b9bbbe;
            padding: 20px;
        }
        
        .error {
            color: #ed4245;
            text-align: center;
            padding: 20px;
        }
        
        .access-denied {
            text-align: center;
            padding: 50px;
            color: #ed4245;
        }
        
        .access-denied h2 {
            margin-bottom: 20px;
        }
        
        .back-home {
            display: inline-block;
            background: #5865f2;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 8px;
            margin-top: 20px;
        }

        .activity-item {
            background: #2c2f33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-title {
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .activity-details {
            color: #b9bbbe;
            font-size: 14px;
        }

        .activity-time {
            color: #5865f2;
            font-weight: 600;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-crown"></i> INC BOT Admin Dashboard</h1>
            <p>Bot Owner Control Panel</p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div id="firebase-status" style="background: #57f287; color: black; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                    <i class="fas fa-database"></i> Firebase Connected
                </div>
                <button class="refresh-btn" onclick="loadDashboardData()">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <a href="/auth/logout" class="refresh-btn" style="text-decoration: none; display: inline-flex; align-items: center;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>

        <div id="access-check" class="loading">
            <i class="fas fa-spinner fa-spin"></i> Verifying access...
        </div>

        <div id="dashboard-content" style="display: none;">
            <div class="admin-grid">
                <!-- Server Statistics -->
                <div class="admin-card">
                    <h3><i class="fas fa-server"></i> Server Overview</h3>
                    <div id="server-overview" class="loading">Loading...</div>
                </div>

                <!-- Bot Metrics -->
                <div class="admin-card">
                    <h3><i class="fas fa-chart-line"></i> Bot Metrics</h3>
                    <div id="bot-metrics" class="loading">Loading...</div>
                </div>

                <!-- Firebase Analytics -->
                <div class="admin-card">
                    <h3><i class="fas fa-database"></i> Firebase Analytics</h3>
                    <div id="firebase-analytics" class="loading">Loading...</div>
                </div>

                <!-- Top Commands -->
                <div class="admin-card">
                    <h3><i class="fas fa-terminal"></i> Command Usage</h3>
                    <div id="command-usage" class="loading">Loading...</div>
                </div>

                <!-- User Activity -->
                <div class="admin-card">
                    <h3><i class="fas fa-users"></i> User Activity</h3>
                    <div id="user-activity" class="loading">Loading...</div>
                </div>

                <!-- System Health -->
                <div class="admin-card">
                    <h3><i class="fas fa-heartbeat"></i> System Health</h3>
                    <div id="system-health" class="loading">Loading...</div>
                </div>
            </div>

            <!-- Server List -->
            <div class="admin-card">
                <h3><i class="fas fa-list"></i> Server Details</h3>
                <div id="server-list" class="loading">Loading server list...</div>
            </div>
        </div>

        <div id="access-denied" class="access-denied" style="display: none;">
            <h2><i class="fas fa-lock"></i> Access Denied</h2>
            <p>You are not authorized to view this dashboard.</p>
            <p>Only the bot owner can access this panel.</p>
            <a href="/" class="back-home">← Back to Home</a>
        </div>
    </div>

    <script>
        // Real-time database data
        let realtimeData = {
            guilds: {},
            userStats: {},
            systemMetrics: {},
            commandLogs: []
        };

        // Initialize real-time listeners
        function initializeRealtimeListeners() {
            // Listen for guild data changes
            fetch('/api/admin/firebase-data')
                .then(response => response.json())
                .then(data => {
                    realtimeData = data;
                    updateRealtimeDisplays();
                })
                .catch(error => console.error('Error fetching Firebase data:', error));

            // Update every 30 seconds for real-time feel
            setInterval(() => {
                fetch('/api/admin/firebase-data')
                    .then(response => response.json())
                    .then(data => {
                        realtimeData = data;
                        updateRealtimeDisplays();
                    })
                    .catch(error => console.error('Error updating Firebase data:', error));
            }, 30000);
        }

        // Update real-time displays
        function updateRealtimeDisplays() {
            updateGuildAnalytics();
            updateUserActivity();
            updateSystemHealth();
        }

        // Update guild analytics from Firebase
        function updateGuildAnalytics() {
            const analytics = realtimeData.analytics || {};
            
            // Update guild analytics display with enhanced metrics
            const analyticsHtml = `
                <div class="metric-item">
                    <span class="metric-label">Total Guilds</span>
                    <span class="metric-value">${analytics.totalGuilds || 0}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Active Configurations</span>
                    <span class="metric-value">${analytics.guildsWithSettings || 0}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Auto-mod Enabled</span>
                    <span class="metric-value">${analytics.guildsWithAutomod || 0}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Total Embeds</span>
                    <span class="metric-value">${analytics.totalEmbeds || 0}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Restricted Channels</span>
                    <span class="metric-value">${analytics.totalRestrictedChannels || 0}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Last Sync</span>
                    <span class="metric-value">${new Date().toLocaleTimeString()}</span>
                </div>
            `;
            
            const container = document.getElementById('firebase-analytics');
            if (container) {
                container.innerHTML = analyticsHtml;
            }
        }

        // Update user activity from Firebase
        function updateUserActivity() {
            const recentActivity = realtimeData.recentActivity || [];
            
            let activityHtml = '';
            
            if (recentActivity.length > 0) {
                // Show last 5 activities
                recentActivity.slice(0, 5).forEach(activity => {
                    const timeAgo = getTimeAgo(activity.timestamp);
                    const icon = activity.type === 'embed_created' ? 'fa-plus' : 'fa-edit';
                    
                    activityHtml += `
                        <div class="activity-item">
                            <div class="activity-info">
                                <div class="activity-title">
                                    <i class="fas ${icon}"></i> ${activity.details}
                                </div>
                                <div class="activity-details">Guild ID: ${activity.guildId}</div>
                            </div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    `;
                });
            } else {
                activityHtml = `
                    <div class="activity-item">
                        <div class="activity-info">
                            <div class="activity-title">No Recent Activity</div>
                            <div class="activity-details">No database changes in the last 24 hours</div>
                        </div>
                        <div class="activity-time">-</div>
                    </div>
                `;
            }

            const container = document.getElementById('user-activity');
            if (container) {
                container.innerHTML = activityHtml;
            }
        }

        // Helper function to get time ago
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        // Update system health metrics
        function updateSystemHealth() {
            const guilds = realtimeData.guilds || {};
            const totalStorageUsed = JSON.stringify(guilds).length;
            const storageKB = Math.round(totalStorageUsed / 1024 * 10) / 10;

            const healthHtml = `
                <div class="metric-item">
                    <span class="metric-label">Database Size</span>
                    <span class="metric-value">${storageKB} KB</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Connection Status</span>
                    <span class="metric-value" style="color: #57f287;">Active</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Last Sync</span>
                    <span class="metric-value">${new Date().toLocaleTimeString()}</span>
                </div>
            `;

            const container = document.getElementById('system-health');
            if (container) {
                container.innerHTML = healthHtml;
            }
        }

        // Check if user is bot owner
        async function checkAccess() {
            try {
                const response = await fetch('/api/admin/verify');
                const data = await response.json();
                
                if (data.authorized) {
                    document.getElementById('access-check').style.display = 'none';
                    document.getElementById('dashboard-content').style.display = 'block';
                    
                    // Update header with user info
                    if (data.user) {
                        const userInfo = document.createElement('div');
                        userInfo.style.cssText = 'color: white; font-size: 14px; margin-top: 10px;';
                        userInfo.innerHTML = `<i class="fas fa-user"></i> Logged in as ${data.user.username}`;
                        document.querySelector('.admin-header').appendChild(userInfo);
                    }
                    
                    loadDashboardData();
                    initializeRealtimeListeners();
                } else {
                    document.getElementById('access-check').style.display = 'none';
                    document.getElementById('access-denied').style.display = 'block';
                }
            } catch (error) {
                console.error('Access check failed:', error);
                
                // Check if it's an authentication error
                if (error.message.includes('401') || window.location.search.includes('error=auth_required')) {
                    showLoginPrompt();
                } else {
                    document.getElementById('access-check').style.display = 'none';
                    document.getElementById('access-denied').style.display = 'block';
                }
            }
        }
        
        // Show login prompt for unauthenticated users
        function showLoginPrompt() {
            document.getElementById('access-check').style.display = 'none';
            document.getElementById('access-denied').innerHTML = `
                <h2><i class="fas fa-sign-in-alt"></i> Authentication Required</h2>
                <p>Please log in with Discord to access the admin dashboard.</p>
                <p>Only the bot owner can access this panel.</p>
                <a href="/auth/discord?scope=admin" class="btn btn-primary" style="display: inline-block; background: #5865f2; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; margin: 20px 10px;">
                    <i class="fab fa-discord"></i> Login with Discord
                </a>
                <a href="/" class="back-home">← Back to Home</a>
            `;
            document.getElementById('access-denied').style.display = 'block';
        }

        async function loadDashboardData() {
            try {
                // Load all dashboard data
                const [serverOverview, botMetrics, commandUsage, systemStatus, serverList] = await Promise.all([
                    fetch('/api/admin/server-overview').then(r => r.json()),
                    fetch('/api/admin/bot-metrics').then(r => r.json()),
                    fetch('/api/admin/command-usage').then(r => r.json()),
                    fetch('/api/admin/system-status').then(r => r.json()),
                    fetch('/api/admin/server-list').then(r => r.json())
                ]);

                // Update server overview
                document.getElementById('server-overview').innerHTML = `
                    <div class="metric-item">
                        <span class="metric-label">Total Servers</span>
                        <span class="metric-value">${serverOverview.totalServers}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Total Users</span>
                        <span class="metric-value">${serverOverview.totalUsers.toLocaleString()}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Largest Server</span>
                        <span class="metric-value">${serverOverview.largestServer}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Avg Members/Server</span>
                        <span class="metric-value">${Math.round(serverOverview.avgMembers)}</span>
                    </div>
                `;

                // Update bot metrics
                document.getElementById('bot-metrics').innerHTML = `
                    <div class="metric-item">
                        <span class="metric-label">Total Commands</span>
                        <span class="metric-value">${botMetrics.totalCommands.toLocaleString()}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Uptime</span>
                        <span class="metric-value">${botMetrics.uptime}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Memory Usage</span>
                        <span class="metric-value">${botMetrics.memoryUsage} MB</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Ping</span>
                        <span class="metric-value">${botMetrics.ping} ms</span>
                    </div>
                `;

                // Update command usage
                const commandHtml = Object.entries(commandUsage)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10)
                    .map(([cmd, count]) => `
                        <div class="command-item">
                            <span class="command-name">/${cmd}</span>
                            <span class="command-count">${count}</span>
                        </div>
                    `).join('');
                
                document.getElementById('command-usage').innerHTML = `
                    <div class="command-stats">${commandHtml}</div>
                `;

                // Update system status
                document.getElementById('system-status').innerHTML = `
                    <div class="metric-item">
                        <span class="metric-label">Status</span>
                        <span class="metric-value" style="color: #57f287;">Online</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Last Restart</span>
                        <span class="metric-value">${systemStatus.lastRestart}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Commands/Hour</span>
                        <span class="metric-value">${systemStatus.commandsPerHour}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Error Rate</span>
                        <span class="metric-value">${systemStatus.errorRate}%</span>
                    </div>
                `;

                // Update server list
                const serverListHtml = serverList.map(server => `
                    <div class="server-item">
                        <div class="server-info">
                            <div class="server-name">${server.name}</div>
                            <div class="server-details">
                                ID: ${server.id} • Owner: ${server.owner} • Created: ${server.joinedAt}
                            </div>
                        </div>
                        <div class="server-stats">
                            ${server.memberCount} members
                        </div>
                    </div>
                `).join('');

                document.getElementById('server-list').innerHTML = `
                    <div class="server-list">${serverListHtml}</div>
                `;

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('server-overview').innerHTML = '<div class="error">Error loading data</div>';
            }
        }

        // Initialize dashboard
        checkAccess();

        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
